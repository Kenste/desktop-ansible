---
- name: Ensure parent directories exist for file configs
  ansible.builtin.file:
    path: "{{ item.src | dirname }}"
    state: directory
  loop: "{{ config_entries | selectattr('is_file', 'defined') | selectattr('is_file') | list }}"
  loop_control:
    label: "{{ item.name }}"
  when: item.dest is exists

- name: Ensure destination directories exist for directory configs
  ansible.builtin.file:
    path: "{{ item.src }}"
    state: directory
  loop: "{{ config_entries | rejectattr('is_file', 'defined') | rejectattr('system', 'defined') | list }}"
  loop_control:
    label: "{{ item.name }}"
  when: item.dest is exists

- name: Ensure destination directories exist for system configs
  ansible.builtin.file:
    path: "{{ item.src }}"
    state: directory
  loop: "{{ config_entries | selectattr('system', 'defined') | selectattr('system') | list }}"
  loop_control:
    label: "{{ item.name }}"
  when: item.dest is exists
  become: true

- name: Restore configs from repo onto system
  ansible.posix.synchronize:
    src: "{{ item.dest }}"
    dest: "{{ item.src }}"
    mode: push
    delete: false
    rsync_opts: >-
      {{ ((['--no-owner', '--no-group', '--include=*/', '-m'] + (item.includes | map('regex_replace', '^(.*)$', '--include=\1') | list) + ['--exclude=*']) | map('quote') | list)
         if item.includes is defined
         else (((['--no-owner', '--no-group'] + (item.excludes | map('regex_replace', '^(.*)$', '--exclude=\1') | list)) | map('quote') | list)
         if item.excludes is defined
         else ['--no-owner', '--no-group']) }}
  loop: "{{ config_entries | rejectattr('is_file', 'defined') | rejectattr('system', 'defined') | list }}"
  loop_control:
    label: "{{ item.name }}"
  when: item.dest is exists
  delegate_to: localhost

- name: Restore system configs from repo onto system
  ansible.builtin.copy:
    src: "{{ item.dest }}"
    dest: "{{ item.src }}"
    mode: preserve
  loop: "{{ config_entries | selectattr('system', 'defined') | selectattr('system') | list }}"
  loop_control:
    label: "{{ item.name }}"
  when: item.dest is exists
  become: true

# Replace @@HOME@@ placeholder with actual home path in restored files
- name: Find restored COSMIC wallpaper config files
  ansible.builtin.find:
    paths:
      - "{{ ansible_facts['env']['HOME'] }}/.config/cosmic/com.system76.CosmicBackground"
      - "{{ ansible_facts['env']['HOME'] }}/.config/cosmic/com.system76.CosmicSettings.Wallpaper"
    recurse: true
    file_type: file
  register: cosmic_wallpaper_files

- name: Replace @@HOME@@ with actual home path in COSMIC wallpaper configs
  ansible.builtin.replace:
    path: "{{ item.path }}"
    regexp: "@@HOME@@"
    replace: "{{ ansible_facts['env']['HOME'] }}"
  loop: "{{ cosmic_wallpaper_files.files }}"
  loop_control:
    label: "{{ item.path | basename }}"
  when: cosmic_wallpaper_files.files | length > 0

- name: Find restored Floorp SSB desktop files
  ansible.builtin.find:
    paths: "{{ ansible_facts['env']['HOME'] }}/.local/share/applications"
    patterns: "floorp-*.desktop"
  register: floorp_ssb_desktop_files

- name: Replace @@HOME@@ with actual home path in Floorp SSB desktop files
  ansible.builtin.replace:
    path: "{{ item.path }}"
    regexp: "@@HOME@@"
    replace: "{{ ansible_facts['env']['HOME'] }}"
  loop: "{{ floorp_ssb_desktop_files.files }}"
  loop_control:
    label: "{{ item.path | basename }}"
  when: floorp_ssb_desktop_files.files | length > 0

- name: Restore file configs from repo onto system
  ansible.builtin.copy:
    src: "{{ item.dest }}"
    dest: "{{ item.src }}"
    mode: preserve
  loop: "{{ config_entries | selectattr('is_file', 'defined') | selectattr('is_file') | list }}"
  loop_control:
    label: "{{ item.name }}"
  when: item.dest is exists
