---
# Resolve profile to active package groups
- name: Set active package groups
  ansible.builtin.set_fact:
    active_groups: "{{ package_profiles[package_profile] }}"

- name: Display active profile
  ansible.builtin.debug:
    msg: "Profile '{{ package_profile }}': {{ active_groups | join(', ') }}"

# Build flat lists of repo and AUR packages from active groups only
- name: Build repo package list
  ansible.builtin.set_fact:
    repo_packages: >-
      {{ active_groups | map('extract', package_groups) | flatten
         | selectattr('arch', 'defined') | map(attribute='arch')
         | selectattr('repo', 'defined') | map(attribute='repo') | flatten | unique | list }}

- name: Build AUR package list
  ansible.builtin.set_fact:
    aur_packages: >-
      {{ active_groups | map('extract', package_groups) | flatten
         | selectattr('arch', 'defined') | map(attribute='arch')
         | selectattr('aur', 'defined') | map(attribute='aur') | flatten | unique | list }}

- name: Display packages to install
  ansible.builtin.debug:
    msg: |
      Repo packages ({{ repo_packages | length }}): {{ repo_packages | join(', ') }}
      AUR packages ({{ aur_packages | length }}): {{ aur_packages | join(', ') }}

# Enable multilib repo (needed for steam, etc.)
- name: Enable multilib repository
  ansible.builtin.replace:
    path: /etc/pacman.conf
    regexp: '^\#?\[multilib\]\n\#?Include = /etc/pacman\.d/mirrorlist'
    replace: "[multilib]\nInclude = /etc/pacman.d/mirrorlist"
  become: true
  when: "'steam' in repo_packages"

# Full system upgrade first to avoid partial upgrade issues
- name: Update system
  community.general.pacman:
    update_cache: true
    upgrade: true
  become: true

# Ensure playbook dependencies are installed
- name: Install playbook dependencies
  community.general.pacman:
    name:
      - rsync
      - git
    state: present
  become: true

# Install official repo packages
- name: Install official repo packages
  community.general.pacman:
    name: "{{ repo_packages }}"
    state: present
  become: true
  when: repo_packages | length > 0

# Require an AUR helper for AUR packages
- name: Fail if AUR packages needed but no helper available
  ansible.builtin.fail:
    msg: >-
      AUR packages ({{ aur_packages | join(', ') }}) require an AUR helper (paru or yay)
      but none was found. Install one first, e.g.: pacman -S paru
  when: aur_packages | length > 0 and aur_helper == 'none'

- name: Install AUR packages
  when: aur_packages | length > 0 and aur_helper != 'none'
  block:
    - name: Allow passwordless pacman for AUR helper
      ansible.builtin.copy:
        content: "{{ local_user }} ALL=(ALL) NOPASSWD: /usr/bin/pacman"
        dest: /etc/sudoers.d/99-ansible-aur
        mode: "0440"
        validate: "visudo -cf %s"
      become: true

    - name: Install AUR packages
      ansible.builtin.command:
        cmd: "{{ aur_helper }} -S --needed --noconfirm {{ item }}"
      loop: "{{ aur_packages }}"
      register: aur_result
      changed_when: "'installing' in aur_result.stdout or 'reinstalling' in aur_result.stdout"

  always:
    - name: Remove temporary sudoers rule
      ansible.builtin.file:
        path: /etc/sudoers.d/99-ansible-aur
        state: absent
      become: true
